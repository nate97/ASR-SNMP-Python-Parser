import subprocess
import datetime
import time
import os
import csv


### GLOBALS ###

#### Variables for header names ####

REGION = " REGION "
NETWORK = " NETWORK "
ID = " ID "
INTF = " INTF "
ADMIN = " ADMIN "
SUBSCRID = " SUBSCR-ID "
DESCR = " DESCR "
ONT = " ONT "
ID = " ID "
OUTTAG = " OUT-TAG "
INTAG = " IN-TAG "
TAGACTION = " TAG-ACTION "
BWPROF = " BW-PROF "
MCASTPROF = " MCAST-PROF "

# File paths #
FIXEDPATH = ""

# HEADER #
HEADER = ""


class gponCreator():

    def __init__(self):
        print ("CMS file combiner")

        # Figure out which columns the required data is located at
        self.headerKeysGE = self.getColumnPosition("combine_gpon/gpon_ont_ge.csv") # Calculate index values for header names
        self.headerKeysDATA = self.getColumnPosition("combine_gpon/gpon_data.csv") # Calculate index values for header naems

        # This is to remove the unneccessary lines from our CSV files!
        self.externalProcess("awk 'NR>2' combine_gpon/gpon_ont_ge.csv > combine_gpon/gpon_ont_ge_fixed.csv") # Remove first two lines of CSV
        self.externalProcess("awk 'NR>2' combine_gpon/gpon_data.csv > combine_gpon/gpon_data_fixed.csv") # Remove first two lines of CSV

        # Function merges the two provided CSV files
        self.CSVCombiner("combine_gpon/gpon_ont_ge_fixed.csv", "combine_gpon/gpon_data_fixed.csv") # Open both CSV files to be merged



    def getColumnPosition(self, filename):
        fileA = open(filename) # Open file
        lines = fileA.readlines() # Read file

        # List currating
        headerKeys = lines[1].split(",") # Split the second line of csv file into a list
        del headerKeys[-1] # Deletes last item of list, THIS SHOULD BE THE NEW LINE DELIMITER (\n)
        columnCount = len(headerKeys) # Get the count of items in headerKeys

        # Column name to position
        headerConverter = {} # IMPORTANT # This is where we place our keys and values into, example: position 5 is the ID header.
        for y in range(0, columnCount): # Iterates over amount of items in columnCount
            headerConverter[headerKeys[y]] = y # Appends the header name as the key, and the value as the integer location of header

        return headerConverter # Returns dictionary



    def CSVCombiner(self, file1, file2):
        # First variable is the opened file in python, the second variable is the python CSV pointer ( these are important )
        newReader1, newFile1 = self.openCSV("GPON.csv", "w") # File to write to
        csvFileReader1, csvFile1 = self.openCSV(file1, "r")
        csvFileReader2, csvFile2 = self.openCSV(file2, "r")

        mergedData = [] # Where all of our merged data from each file goes

        # Convert both of our files into a list so we can easily iterate over their data
        file1List = self.file2List(csvFileReader1)
        file2List = self.file2List(csvFileReader2)

        for rowsGE in file1List: ##### GE File ##### FIRST FILE
            regionGE = rowsGE[self.headerKeysGE[REGION]]  # Extract position of region from headerKeysGE
            descrGE = rowsGE[self.headerKeysGE[DESCR]]
            idGE = rowsGE[self.headerKeysGE[ONT]]

            ##### IGNORE THE JUNK DATA #####
            if descrGE == " ":
                continue
            if regionGE == " ":
                continue
            if idGE == " ":
                continue

            for rowsDATA in file2List: ##### Data File ##### SECOND FILE
                regionData = rowsDATA[self.headerKeysDATA[REGION]]
                descrData = rowsDATA[self.headerKeysDATA[DESCR]]
                idData = rowsDATA[self.headerKeysDATA[ID]]
                octetOutData = rowsDATA[self.headerKeysDATA[INTAG]]

                ##### IGNORE THE JUNK DATA #####
                if regionData == " ":
                    continue
                if idData == " ":
                    continue
                if octetOutData == "Not Used": # THIS MIGHT NOT BE THE CORRECT THING TODO!!!
                    continue

                # Special case that formats our data correctly
                idData = self.IDCorrector(idData) # Correct the format of the data in ID column

                # IF we have a collision, continue
                if regionGE == regionData and idGE == idData: # If we have a match on a single line ( IN BOTH FILES ) we will merge that data
                    #print ("Collision")

                    collidedDataList = [] # This is the list we append our collided data from the two files into, one is generated for EACH customer

                    collidedDataList.append(rowsDATA[self.headerKeysDATA[NETWORK]])
                    collidedDataList.append(rowsDATA[self.headerKeysDATA[BWPROF]])
                    collidedDataList.append(rowsDATA[self.headerKeysDATA[OUTTAG]])
                    collidedDataList.append(rowsDATA[self.headerKeysDATA[INTAG]])
                    collidedDataList.append(rowsDATA[self.headerKeysDATA[MCASTPROF]])
                    collidedDataList.append(rowsDATA[self.headerKeysDATA[ID]])
                    collidedDataList.append(rowsGE[self.headerKeysGE[DESCR]]) # GE
                    collidedDataList.append(rowsGE[self.headerKeysGE[ONT]]) # GE

                    #print (collidedDataList)
                    mergedData.append(collidedDataList)

        # Crappy solution to export data to the new CSV file
        for data in mergedData:
            print (data)
            stringy = ",".join(data)
            newFile1.write(stringy + "\n")



    # Opens a provided file and then opens the file with CSV reader
    def openCSV(self, filename, openType):
        fileObject = open(filename, openType)
        csvReaderObject = csv.reader(fileObject, delimiter=',')
        return csvReaderObject, fileObject



    # Iterates over every line in file and places them into a list
    def file2List(self, filename):
        fileList = []  # Place all valid data from csv file in here

        for line in filename:
            fileList.append(line) # Append our line list to a static list

        return fileList



    # Removes extraneous garbage off of ID field FROM the (DATA) file
    def IDCorrector(self, ID):
        correctedID = ID # Default failover

        id = ID.split("-GE") # Remove the -GE
        id = id[0] # Selects the correct string from previous statement

        try:
            id = id.split("-", 1) # Split the second dash
            correctedID = (id[1]) # Select the correct string from previous statement
        except:
             pass

        return correctedID



    # Runs external bash commands
    def externalProcess(self, command):
        subprocess.call(command, shell=True)



gponCreator()


